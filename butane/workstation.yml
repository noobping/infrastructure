variant: fcos
version: 1.6.0

boot_device:
  luks:
    tpm2: true

storage:
  files:
    - path: /etc/hostname
      mode: 0440
      contents:
        inline: |
          workstation

systemd:
  units:
    - name: clevis-luks-askpass.service
      mask: true
    - name: clevis-luks-askpass.path
      mask: true
    - name: sshd.service
      mask: true
    - name: getty@.service
      mask: true
    - name: serial-getty@.service
      mask: true
    - name: emergency.service
      mask: true
    - name: rescue.service
      mask: true
    - name: switcheroo-control.service
      enabled: true
    - name: power-profiles-daemon.service
      enabled: true
    - name: upower.service
      enabled: true
    - name: plymouth-start.service
      enabled: true
    - name: rebase-to-workstation.service
      enabled: true
      contents: |
        [Unit]
        Description=Rebase FCOS to boot container image
        Wants=network-online.target NetworkManager-wait-online.service
        After=network-online.target NetworkManager-wait-online.service
        ConditionPathExists=!/var/lib/rebase.done

        [Service]
        Type=oneshot
        Restart=on-failure
        RestartSec=30s
        StartLimitIntervalSec=0
        ExecStart=/usr/bin/rpm-ostree rebase ostree-image-signed:docker://ghcr.io/noobping/workstation:latest
        ExecStart=/usr/bin/rpm-ostree kargs --append=quiet --append=splash --append=loglevel=3 --append=systemd.show_status=false --append=rd.systemd.show_status=false
        ExecStart=/usr/bin/touch /var/lib/rebase.done
        ExecStart=/usr/bin/systemctl --no-block reboot

        [Install]
        WantedBy=multi-user.target

    - name: system-flatpaks.service
      enabled: true
      contents: |
        [Unit]
        Description=Install system Flatpaks
        Wants=network-online.target
        After=network-online.target
        ConditionPathExists=/var/lib/rebase.done
        ConditionPathExists=!/var/lib/system-flatpaks.done

        [Service]
        Type=oneshot
        Restart=on-failure
        RestartSec=30s
        StartLimitIntervalSec=0
        ExecStart=/usr/bin/flatpak remote-add --system --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
        ExecStart=/usr/bin/flatpak install --system --noninteractive flathub \
          com.belmoussaoui.Decoder \
          com.mattjakeman.ExtensionManager \
          io.github.kolunmi.Bazaar \
          org.gnome.Calendar \
          org.gnome.Epiphany \
          org.gnome.Loupe \
          org.gnome.Papers \
          org.gnome.TextEditor
        ExecStart=/usr/bin/touch /var/lib/system-flatpaks.done

        [Install]
        WantedBy=multi-user.target
    - name: update-system-flatpaks.service
      enabled: true
      contents: |
        [Unit]
        Description=Update system flatpaks
        Wants=network-online.target
        After=network-online.target
        ConditionPathExists=/var/lib/system-flatpaks.done

        [Service]
        Type=oneshot
        Restart=on-failure
        RestartSec=30s
        StartLimitIntervalSec=0
        ExecStart=/usr/bin/flatpak update --system --noninteractive

        [Install]
        WantedBy=multi-user.target
